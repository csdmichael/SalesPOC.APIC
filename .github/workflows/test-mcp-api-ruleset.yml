name: Test MCP API with MCP Ruleset

on:
  workflow_dispatch:
    inputs:
      mcp_url:
        description: MCP server URL to test
        required: true
        type: string
        default: https://apim-poc-my.azure-api.net/cosmos/mcp
      apim_subscription_key:
        description: Optional APIM subscription key (required for protected endpoints)
        required: false
        type: string
        default: ''
  push:
    branches: [main]
    paths:
      - 'rulesets/mcp-ruleset/**'
      - '.github/workflows/test-mcp-api-ruleset.yml'

permissions:
  contents: read

jobs:
  spectral-test-mcp:
    name: Spectral Test (MCP)
    runs-on: ubuntu-latest

    env:
      MCP_BASE_URL: ${{ inputs.mcp_url || 'https://apim-poc-my.azure-api.net/cosmos/mcp' }}
      APIM_SUBSCRIPTION_KEY: ${{ inputs.apim_subscription_key || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli

      - name: Discover MCP manifest URL
        id: discover
        shell: bash
        run: |
          set -euo pipefail

          base_url="${MCP_BASE_URL%/}"
          api_root="$base_url"

          if [[ "$base_url" =~ /mcp$ ]]; then
            api_root="${base_url%/*}"
          fi

          candidates=(
            "$base_url/manifest"
            "$base_url/mcp.json"
            "$base_url/.well-known/mcp.json"
            "$base_url/capabilities"
            "$base_url/metadata"
            "$api_root/manifest"
            "$api_root/mcp.json"
            "$api_root/.well-known/mcp.json"
            "$api_root/capabilities"
            "$api_root/metadata"
            "$base_url"
            "$api_root"
          )

          curl_args=(
            -fsSL
            --connect-timeout 5
            --max-time 12
            -H "Accept: application/json"
          )

          if [[ -n "${APIM_SUBSCRIPTION_KEY:-}" ]]; then
            curl_args+=( -H "Ocp-Apim-Subscription-Key: ${APIM_SUBSCRIPTION_KEY}" )
          fi

          found=""

          for url in "${candidates[@]}"; do
            echo "Trying: $url"

            if curl "${curl_args[@]}" "$url" -o mcp.tmp 2>/dev/null; then
              if grep -Eq '"protocolVersion"|"serverInfo"|"capabilities"' mcp.tmp; then
                found="$url"
                mv mcp.tmp mcp-manifest.json
                echo "Found MCP manifest-like document at: $url"
                break
              fi
            fi
          done

          if [[ -z "$found" ]]; then
            echo "Could not find an MCP manifest document for $base_url" >&2
            echo "Checked candidates:" >&2
            printf ' - %s\n' "${candidates[@]}" >&2
            exit 1
          fi

          echo "manifest_url=$found" >> "$GITHUB_OUTPUT"

      - name: Lint MCP manifest with mcp-ruleset
        run: |
          spectral lint mcp-manifest.json \
            --ruleset rulesets/mcp-ruleset/ruleset.yaml \
            --format stylish

      - name: Summary
        if: always()
        run: |
          echo "MCP ruleset test finished for: $MCP_BASE_URL"
          echo "MCP manifest source: ${{ steps.discover.outputs.manifest_url }}"
